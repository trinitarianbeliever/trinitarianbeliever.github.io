<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahan Yosef | Search</title>
    <meta name="description" content="Search articles and resources on Trinitarian Believer.">
    <meta name="keywords" content="search, Trinitarian, theology, Christianity, articles, archives, faith, Jesus, God">
    <link rel="icon" type="image/x-icon" href="./img/favicon.jpg">
    <link rel="stylesheet" href="./src/style.css">
    <link rel="icon" type="image/x-icon" href="./img/favicon.jpg">
</head>
<body>
    <header>
        <h1>Christian apologetics by Sahan Yosef</h1>
        <p>
            <a href="./index.html" class="highlight">Writings</a>
            | 
            <a href="./categories.html" class="highlight">Categories</a> 
            | 
            <a href="./search.html" class="highlight">Search</a> 
            | 
            <a href="./about.html" class="highlight">About</a> 
        </p>
        <hr>
    </header>

    <main class="page-container">
        
        <!-- Search Input Section (Now always FIRST) -->
        <section class="search-container">
            
            <form class="search-form-body" onsubmit="event.preventDefault(); handleSearch();">
                <input 
                    type="search" 
                    id="searchInput" 
                    class="search-input-body" 
                    placeholder="Search keywords..." 
                    aria-label="Search keywords"
                    required
                >
                <button type="submit" class="search-button-body">Search</button>
            </form>
        </section>
        
        <!-- Search Results Section (Now always SECOND) -->
        <section class="search-results" id="searchResults">
            <!-- Results will be dynamically inserted here. -->
            <div class="no-results"><p>Loading search index...</p></div>
        </section>
        
    </main>
    
    <script>
        // Placeholder for articles (will be populated by fetch)
        let articles = [];

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const searchResultsContainer = document.getElementById('searchResults');
        const menuCheckbox = document.getElementById('menu-toggle-checkbox');

        // Common, unhelpful words to ignore in search queries
        const STOP_WORDS = [
            'the', 'a', 'an', 'is', 'of', 'in', 'and', 'or', 'for', 'to', 'with',
            'how', 'what', 'why', 'who', 'where', 'when', 'which', 'was', 'are', 'by',
            'my', 'your', 'his', 'her', 'its', 'our', 'their', 'at', 'on', 'up', 'down',
            'from', 'about', 'just', 'that', 'this', 'it', 'me', 'you', 'he', 'she',
            'we', 'they', 'i', 's', 'can', 'will', 'do', 'be', 'as'
        ];
        
        // --- DATA LOADING & INITIALIZATION ---

        /**
         * Loads article data from a JSON file.
         */
        async function loadArticles() {
            // NOTE: The JSON file is expected at "./searchdata/data.json"
            // The format should be an array of objects like:
            // [{"title": "Article Title", "url": "./path/to/article.html"}, ...]
            try {
                const response = await fetch('./searchdata/data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                articles = await response.json();
                console.log('Articles loaded successfully:', articles.length);
                searchResultsContainer.innerHTML = '<div class="no-results"><p>Search index loaded. Enter keywords above.</p></div>';
            } catch (error) {
                console.error('Failed to load search data:', error);
                searchResultsContainer.innerHTML = '<div class="no-results"><p>Error: Could not load article index. Please ensure the file "./searchdata/data.json" exists and is properly formatted.</p></div>';
            }
        }

        /**
         * Initializes the page by loading data and checking for URL query.
         */
        async function initializePage() {
            // 1. Load articles data
            await loadArticles();

            // 2. Check URL for existing query (e.g., search.html?q=begetting)
            const urlParams = new URLSearchParams(window.location.search);
            const initialQuery = urlParams.get('q');
            
            if (initialQuery) {
                // Set the input field value
                searchInput.value = initialQuery;
                // Run the search logic
                executeSearch(initialQuery); 
            }
        }

        // --- SEARCH LOGIC ---

        /**
         * Simple XSS sanitizer to escape HTML special characters.
         * @param {string} str The string to sanitize.
         * @returns {string} The sanitized string.
         */
        function sanitize(str) {
            if (!str || typeof str !== 'string') return '';
            // Escape HTML special characters for safe output in innerHTML
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#39;');
        }

        /**
         * Executes the core search logic based on a query string.
         * @param {string} query The raw search query string.
         */
        function executeSearch(rawQuery) {
            rawQuery = rawQuery.trim().toLowerCase();
            searchResultsContainer.innerHTML = ''; // Clear previous results

            // Sanitize the query specifically for safe output to the HTML DOM
            const safeQueryDisplay = sanitize(rawQuery);

            // 1. Check if data is loaded
            if (articles.length === 0) {
                 searchResultsContainer.innerHTML = '<div class="no-results"><p>Article data is not yet loaded or is unavailable.</p></div>';
                 return;
            }

            // 2. Minimum query length check
            if (rawQuery.length < 3) {
                searchResultsContainer.innerHTML = '<div class="no-results"><p>Please enter at least 3 characters to search.</p></div>';
                return;
            }
            
            // 3. Tokenize and clean the query
            const queryWords = rawQuery
                .split(/\s+/) // Split by one or more spaces
                .filter(word => word.length > 0 && !STOP_WORDS.includes(word)); // Remove empty strings and stopwords

            // If only stopwords remain after cleaning, use the raw query as the only effective word
            const effectiveQueryWords = queryWords.length > 0 ? queryWords : [rawQuery];

            // 4. Filter articles (requires all effective query words to be in the title)
            const filteredResults = articles.filter(article => {
                const articleTitleLower = article.title.toLowerCase();
                
                // Check if ALL effective query words are present in the article title
                return effectiveQueryWords.every(word => articleTitleLower.includes(word));
            });

            // 5. Display results
            if (filteredResults.length === 0) {
                // Using the safeQueryDisplay variable here prevents XSS if the user enters HTML/script.
                searchResultsContainer.innerHTML = '<div class="no-results"><p>No results found for "' + safeQueryDisplay + '". Try a different search term.</p></div>';
                return;
            }

            filteredResults.forEach(article => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                
                // HTML output only includes the clickable title
                resultItem.innerHTML = `
                    <h3 class="result-title">
                        <a href="${article.url}">${article.title}</a>
                    </h3>
                `;

                searchResultsContainer.appendChild(resultItem);
            });
        }
        
        /**
         * Event handler for the search form submission.
         */
        function handleSearch() {
            const rawQuery = searchInput.value;
            
            // Close the mobile menu after search
            if (window.innerWidth <= 768) {
                menuCheckbox.checked = false;
            }

            // Execute the search logic
            executeSearch(rawQuery);
        }

        // --- EVENT LISTENERS ---
        
        document.addEventListener('DOMContentLoaded', () => {
            // Start the data loading and initial search check
            initializePage(); 

            // Mobile menu toggle logic
            const checkbox = document.getElementById('menu-toggle-checkbox');
            
            // Close menu when a link is clicked (mobile only)
            const navLinks = document.querySelectorAll('.main-nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        checkbox.checked = false;
                    }
                });
            });
        });
    </script>
</body>
</html>

